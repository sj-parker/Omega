import asyncio
import re
import sys
import os
from pathlib import Path

# Add project root to path
sys.path.insert(0, str(Path(__file__).parent))

try:
    from main import CognitiveSystem
    from core.config import config
except ImportError as e:
    print(f"Error importing modules: {e}")
    sys.exit(1)

async def run_tests():
    input_file = "testQuestion.txt"
    if not os.path.exists(input_file):
        print(f"Error: {input_file} not found.")
        return

    print(f"Reading {input_file}...")
    with open(input_file, "r", encoding="utf-8") as f:
        content = f.read()

    # Extract questions inside « »
    # We also try to capture the category/context if possible, but for now just the questions
    questions = re.findall(r"«(.*?)»", content)
    
    if not questions:
        print("No questions found in the file (looking for content in «...»).")
        return

    print(f"Found {len(questions)} questions.")

    print("Initializing CognitiveSystem...")
    # Attempt to use config defaults, but ensure Ollama is enabled if configured
    # We won't prompt the user like the CLI does, so we rely on config or defaults.
    # main.py defaults: use_ollama from config.
    system = CognitiveSystem()
    
    # We might need to ensure the event loop is running for background tasks if any
    # CognitiveSystem relies on 'await' so we are good in this async func.

    results = []
    
    output_path = "vulnerability_report.md"
    
    print(f"Starting execution of {len(questions)} questions...")
    
    # Optional: Limit number of questions for testing if needed, but user asked for "all"
    
    with open(output_path, "w", encoding="utf-8") as f:
        f.write("# Vulnerability Test Report\n\n")
        f.write(f"**Date:** {os.times}\n") # Just a placeholder
        f.write(f"**Total Questions:** {len(questions)}\n\n")
        f.write("---\n\n")

    for i, q in enumerate(questions, 1):
        print(f"[{i}/{len(questions)}] Processing: {q}")
        
        try:
            # Using a fixed user_id for consistency
            response = await system.process("security_tester", q)
            
            # Append result to file immediately to allow viewing progress
            with open(output_path, "a", encoding="utf-8") as f:
                f.write(f"### Question {i}\n")
                f.write(f"> {q}\n\n")
                f.write(f"**Response:**\n{response}\n\n")
                f.write("---\n\n")
                
        except Exception as e:
            print(f"Error executing question {i}: {e}")
            with open(output_path, "a", encoding="utf-8") as f:
                f.write(f"### Question {i}\n")
                f.write(f"> {q}\n\n")
                f.write(f"**Error:** {e}\n\n")
                f.write("---\n\n")
    
    # Cleanup if necessary
    if hasattr(system, 'stop_reflection'):
        await system.stop_reflection()

    print(f"\nExecution complete. Results saved to {output_path}")

if __name__ == "__main__":
    asyncio.run(run_tests())
